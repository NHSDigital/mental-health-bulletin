# Databricks notebook source
import pyspark.sql.functions as F

# COMMAND ----------

 %run ./mhsds_functions

# COMMAND ----------

 %run ./breakdown_metadata

# COMMAND ----------

# DBTITLE 1,Chapter 1
ch01_measure_ids = {  
"1a": {
  "name": "Number of people in contact with NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "1a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_higher_prov_type_bd, age_band_chap1_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_gender_age_band_lower_chap1_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_team_type_bd, comm_region_bd, comm_region_age_band_higher_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap1_bd, gender_prov_type_bd, imd_quintile_bd, imd_decile_bd, imd_decile_upper_eth_bd, imd_decile_gender_age_band_lower_chap1_bd, la_bd, la_age_band_higher_bd, prov_bd, prov_type_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, prov_team_type_bd, stp_res_bd, stp_res_age_band_higher_bd, team_type_bd, team_type_age_band_higher_bd, team_type_upper_eth_bd, team_type_gender_bd, team_type_imd_quintile_bd, service_type_bd, service_type_age_band_higher_bd, service_type_upper_eth_bd, service_type_imd_quintile_bd, service_type_gender_bd]
},
"1b": {
  "name": "Number of people admitted as an inpatient with NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": (F.col("Admitted") == "Admitted"),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "1b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_higher_prov_type_bd, age_band_chap1_bd, age_band_lower_chap1_prov_type_bd, bed_type_bd, bed_type_age_band_higher_bd, bed_type_upper_eth_bd, bed_type_gender_bd, bed_type_imd_quintile_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_bed_type_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, comm_region_age_band_higher_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap1_bd, gender_age_band_lower_chap1_prov_type_bd, gender_prov_type_bd, imd_quintile_bd, imd_decile_bd, la_bd, la_age_band_higher_bd, prov_bd, prov_type_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd, stp_res_age_band_higher_bd]
},
"1c": {
  "name": "Number of people not admitted as an inpatient while in contact with NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": (F.col("Admitted") == "Non_Admitted"),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "1c",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_higher_prov_type_bd, age_band_chap1_bd, age_band_lower_chap1_prov_type_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_team_type_bd, comm_region_bd, comm_region_age_band_higher_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap1_bd, gender_age_band_lower_chap1_prov_type_bd, gender_prov_type_bd, imd_quintile_bd, imd_decile_bd, imd_decile_upper_eth_bd, la_bd, la_age_band_higher_bd, prov_bd, prov_type_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd, stp_res_age_band_higher_bd, team_type_bd, team_type_age_band_higher_bd, team_type_upper_eth_bd, team_type_gender_bd, team_type_imd_quintile_bd, service_type_bd, service_type_age_band_higher_bd, service_type_upper_eth_bd, service_type_imd_quintile_bd, service_type_gender_bd]
},
"1d": {
  "name":  "Proportion of people in contact with NHS funded secondary mental health, learning disabilities and autism services admitted as an inpatient",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN Admitted = 'Admitted' THEN Person_ID ELSE NULL END)/COUNT(DISTINCT Person_ID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "1b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_higher_bd, age_band_higher_prov_type_bd, age_band_chap1_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, comm_region_bd, comm_region_age_band_higher_bd, eng_bd, gender_bd, gender_age_band_lower_chap1_bd, gender_prov_type_bd, la_bd, la_age_band_higher_bd, prov_bd, prov_type_bd, stp_res_bd, stp_res_age_band_higher_bd]
},
"1e": {
  "name":  "Proportion of people in contact with NHS funded secondary mental health, learning disabilities and autism services not admitted as an inpatient",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN Admitted = 'Non_Admitted' THEN Person_ID ELSE NULL END)/COUNT(DISTINCT Person_ID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "1c",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_higher_bd, age_band_chap1_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_team_type_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap1_bd, gender_prov_type_bd, imd_quintile_bd, imd_decile_bd, prov_bd, prov_type_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, team_type_bd, team_type_age_band_higher_bd, team_type_upper_eth_bd, team_type_gender_bd, team_type_imd_quintile_bd, service_type_bd, service_type_age_band_higher_bd, service_type_upper_eth_bd, service_type_imd_quintile_bd, service_type_gender_bd]
},
"1g": {
  "name": "Proportion of the population in contact with NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "1a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, age_band_chap1_bd, gender_bd, gender_age_band_lower_chap1_bd]
},
"1h": {
  "name": "Number of people in contact with NHS funded secondary mental health, learning disabilities and autism services with a known age, gender and ethnicity",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": (F.col("Der_Gender").isin(["1", "2"])) & (F.col("AgeRepPeriodEnd").isNotNull()) & (F.col("NHSDEthnicity").isNotNull()) & (~F.col("NHSDEthnicity").isin(["-1", "99", "Z"])),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "1h",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, upper_eth_bd, lower_eth_bd]
},
"1i": {
  "name": "Crude rate of people in contact with NHS funded secondary mental health, learning disabilities and autism services per 100,000 population",
  "freq": "12M", 
  "source_table": "people_in_contact",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "1h",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, upper_eth_bd, lower_eth_bd]
},
"1j": {
  "name": "Standardised rate of people in contact with NHS funded secondary mental health, learning disabilities and autism services per 100,000 population",
  "freq": "12M", 
  "source_table": "Standardisation",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(STANDARDISED_RATE_PER_100000)").alias("METRIC_VALUE")),
  "aggregate_function": produce_std_rate_agg_df,
  "numerator_id": "1h",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [std_upper_eth_bd, std_lower_eth_bd]
},
"1k": {
  "name": "Confidence interval for the standardised rate of people in contact with NHS funded secondary mental health, learning disabilities and autism services per 100,000 population",
  "freq": "12M", 
  "source_table": "Standardisation",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(CONFIDENCE_INTERVAL_95)").alias("METRIC_VALUE")),
  "aggregate_function": produce_std_rate_agg_df,
  "numerator_id": "1h",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [std_upper_eth_bd, std_lower_eth_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 4
ch04_measure_ids = {  
"4a": {
  "name": "Number of in year bed days",
  "freq": "12M", 
  "source_table": "beddays",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(BedDays)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "4a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, age_band_higher_prov_type_bd, age_band_lower_common_prov_type_bd, bed_type_bd, bed_type_age_band_higher_bd, bed_type_upper_eth_bd, bed_type_gender_bd, bed_type_imd_quintile_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_bed_type_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, gender_bd, gender_age_band_lower_common_bd, gender_prov_type_bd, gender_age_band_lower_common_prov_type_bd, imd_quintile_bd, imd_decile_bd, la_bd, prov_bd, prov_type_bd, prov_age_band_higher_bd, prov_bed_type_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 5
ch05_measure_ids = {  
"5a": {
  "name": "Number of admissions to NHS funded secondary mental health, learning disabilities and autism inpatient services",
  "freq": "12M", 
  "source_table": "admissions_discharges",
  "filter_clause": (F.col("StartDateHospProvSpell").between("2022-04-01", "2023-03-31")),
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqHospProvSpellID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "5a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap45_bd, bed_type_bd, bed_type_age_band_higher_bd, bed_type_upper_eth_bd, bed_type_imd_quintile_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap45_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap45_bd, imd_decile_bd, imd_quintile_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"5b": {
  "name": "Number of discharges from NHS funded secondary mental health, learning disabilities and autism inpatient services",
  "freq": "12M", 
  "source_table": "admissions_discharges",
  "filter_clause": (F.col("DischDateHospProvSpell").between("2022-04-01", "2023-03-31")),
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqHospProvSpellID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "5b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap45_bd, bed_type_bd, bed_type_age_band_higher_bd, bed_type_upper_eth_bd, bed_type_imd_quintile_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap45_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap45_bd, imd_decile_bd, imd_quintile_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"5c": {
  "name": "Average (mean) number of daily occupied beds in NHS funded secondary mental health, learning disabilities and autism inpatient services",
  "freq": "12M", 
  "source_table": "beddays",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(BedDays)/365").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "4a",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [ccg_prac_res_bd, comm_region_bd, eng_bd, gender_bd, prov_bd, stp_res_bd, la_bd, imd_decile_bd, age_band_chap45_bd, age_band_higher_bd, upper_eth_bd, gender_age_band_lower_chap45_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 6
ch06_measure_ids = {  
"6a": {
  "name": "Number of contacts with secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "Care_Contacts",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT MHS201UniqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "6a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "count",
  "breakdowns": [att_bd, att_team_type_bd, eng_bd, prov_bd, prov_team_type_bd, team_type_bd, age_band_higher_bd, age_band_common_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd]
},
"6b": {
  "name": "Proportion of contacts with secondary mental health, learning disabilities and autism services which the patient attended",
  "freq": "12M", 
  "source_table": "Care_Contacts",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN AttCode in ('5', '6') THEN MHS201UniqID ELSE NULL END)/COUNT(DISTINCT MHS201UniqID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "6a",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, prov_team_type_bd, team_type_bd, age_band_higher_bd, age_band_common_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd]
},
"6c": {
  "name": "Proportion of contacts with secondary mental health, learning disabilities and autism services which the patient did not attend",
  "freq": "12M", 
  "source_table": "Care_Contacts",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN AttCode in ('7','2','3') THEN MHS201UniqID ELSE NULL END)/COUNT(DISTINCT MHS201UniqID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "6a",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, prov_team_type_bd, team_type_bd, age_band_higher_bd, age_band_common_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd]
},
"6d": {
  "name": "Proportion of contacts with secondary mental health, learning disabilities and autism services which the provider cancelled",
  "freq": "12M", 
  "source_table": "Care_Contacts",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN AttCode = '4' THEN MHS201UniqID ELSE NULL END)/COUNT(DISTINCT MHS201UniqID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "6a",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, prov_team_type_bd, team_type_bd, age_band_higher_bd, age_band_common_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd]
},
"6e": {
  "name": "Proportion of contacts with secondary mental health, learning disabilities and autism services with an invalid or missing attendance code",
  "freq": "12M", 
  "source_table": "Care_Contacts",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN AttCode = 'Unknown' THEN MHS201UniqID ELSE NULL END)/COUNT(DISTINCT MHS201UniqID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "6a",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, prov_team_type_bd, team_type_bd, age_band_higher_bd, age_band_common_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 7
ch07_measure_ids = {  
"7a": {
  "name": "Number of people subject to a restrictive intervention in contact with NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "RI_Prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "7a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, comm_region_int_type_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, int_type_bd, int_type_age_band_lower_common_bd, int_type_gender_bd, int_type_gender_age_band_lower_common_bd, la_bd, la_int_type_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, prov_int_type_bd, stp_res_bd, stp_res_int_type_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd]
},
"7b": {
  "name": "Number of restrictive interventions in NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "RI_Prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqRestraintID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "7b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "restraints",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, comm_region_int_type_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, int_type_bd, int_type_age_band_lower_common_bd, int_type_gender_bd, int_type_gender_age_band_lower_common_bd, la_bd, la_int_type_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, prov_int_type_bd, stp_res_bd, stp_res_int_type_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd]
},
"7c": {
  "name": "Number of people subject to a restrictive intervention in contact with NHS funded secondary mental health, learning disabilities and autism services whose age, gender and ethnicity are known",
  "freq": "12M", 
  "source_table": "RI_Prep",
  "filter_clause": (F.col("Der_Gender").isin(["1", "2"])) & (F.col("AgeRepPeriodEnd").isNotNull()) & (F.col("NHSDEthnicity").isNotNull()) & (~F.col("NHSDEthnicity").isin(["-1", "99", "Z"])),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "7c",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, comm_region_int_type_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, int_type_bd, int_type_age_band_lower_common_bd, int_type_gender_bd, int_type_gender_age_band_lower_common_bd, la_bd, la_int_type_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, prov_int_type_bd, stp_res_bd, stp_res_int_type_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd]
},
"7d": {
  "name": "Crude rate of people subject to a restrictive intervention in contact with NHS funded secondary mental health, learning disabilities and autism services per 100,000 population",
  "freq": "12M", 
  "source_table": "RI_Prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "7c",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, upper_eth_bd, lower_eth_bd, age_band_common_bd, imd_decile_bd, upper_eth_age_band_lower_common_bd, gender_age_band_lower_common_bd]
},
"7e": {
  "name": "Standardised rate of people subject to a restrictive intervention in contact with NHS funded secondary mental health, learning disabilities and autism services per 100,000 population",
  "freq": "12M", 
  "source_table": "Standardisation_Restraint",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(STANDARDISED_RATE_PER_100000)").alias("METRIC_VALUE")),
  "aggregate_function": produce_std_rate_agg_df,
  "numerator_id": "7c",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [std_upper_eth_bd, std_lower_eth_bd]
},
"7f": {
  "name": "Confidence intervals for the standardised rate of people subject to a restrictive intervention in contact with NHS funded secondary mental health, learning disabilities and autism services per 100,000 population (+/-)",
  "freq": "12M", 
  "source_table": "Standardisation_Restraint",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(CONFIDENCE_INTERVAL_95)").alias("METRIC_VALUE")),
  "aggregate_function": produce_std_rate_agg_df,
  "numerator_id": "7c",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [std_upper_eth_bd, std_lower_eth_bd]
},
  "7g": {
  "name": "Number of restrictive intervention incidents in NHS funded secondary mental health, learning disabilities and autism services",
  "freq": "12M", 
  "source_table": "RI_Prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqRestrictiveIntIncID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "7g",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "incidents",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, comm_region_int_type_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, int_type_bd, int_type_age_band_lower_common_bd, int_type_gender_bd, int_type_gender_age_band_lower_common_bd, la_bd, la_int_type_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, prov_int_type_bd, stp_res_bd, stp_res_int_type_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd]
},
  "7h": {
  "name": "Crude rate of restrictive interventions with NHS funded secondary mental health, learning disabilities and autism services per 1,000 occupied bed days",
  "freq": "12M", 
  "source_table": "RI_Prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(BED_DAYS_COUNT), 0))*1000").alias("METRIC_VALUE")),
  "aggregate_function": produce_restr_per_bed_days_agg_df,
  "numerator_id": "7b",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "restraints",
  "suppression": "percent",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, comm_region_int_type_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, int_type_bd, int_type_age_band_lower_common_bd, int_type_gender_bd, int_type_gender_age_band_lower_common_bd, la_bd, la_int_type_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, prov_int_type_bd, stp_res_bd, stp_res_int_type_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd]
},
}

# COMMAND ----------

# DBTITLE 1,Chapter 9
ch09_measure_ids = {  
"9a": {
  "name": "Number of children and young people, receiving at least two contacts (including indirect contacts) in the reporting period and where their first contact occurs before their 18th birthday",
  "freq": "12M", 
  "source_table": "Cont_prep_table_second",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT 2_contact)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "9a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
    "breakdowns": [age_band_chap1_bd, ccg_prac_res_bd, ccg_prac_res_age_band_chap1_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_bd, lower_eth_age_band_lower_chap1_bd, gender_bd, gender_age_band_lower_chap1_bd, imd_quintile_bd, imd_decile_bd, imd_decile_age_band_lower_chap1_bd, la_bd, prov_bd, prov_age_band_chap1_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"9b": {
  "name": "Crude rate of children and young people, receiving at least two contacts (including indirect contacts) in the reporting period and where their first contact occurs before their 18th birthday per 100,000 population aged 0-17",
  "freq": "12M", 
  "source_table": "Cont_prep_table_second",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "9a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap1_bd, ccg_prac_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap1_bd, imd_decile_bd, stp_res_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_age_band_lower_chap1_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 10
ch10_measure_ids = {  
"10a": {
  "name": "Number of referrals on Early Intervention for Psychosis (EIP) pathway that entered treatment",
  "freq": "12M", 
  "source_table": "EIP23a_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqServReqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "10a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap10a_bd, lower_eth_bd, lower_eth_age_band_lower_chap10a_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap10a_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"10b": {
  "name": "Number of referrals on Early Intervention for Psychosis (EIP) pathway that entered treatment within 2 weeks",
  "freq": "12M", 
  "source_table": "EIP23a_common",
  "filter_clause": (F.col("days_between_ReferralRequestReceivedDate") <= 14),
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqServReqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "10b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap10a_bd, lower_eth_bd, lower_eth_age_band_lower_chap10a_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap10a_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"10c": {
  "name": "Proportion of referrals on Early Intervention for Psychosis (EIP) pathway that waited 2 weeks or less to enter treatment",
  "freq": "12M", 
  "source_table": "EIP23a_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN days_between_ReferralRequestReceivedDate <= 14 THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT UniqServReqID)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "10b",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "percent",
  "breakdowns": [age_band_higher_bd, age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap10a_bd, lower_eth_bd, lower_eth_age_band_lower_chap10a_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap10a_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"10d": {
  "name": "Number of open referrals on Early Intervention for Psychosis (EIP) pathway that entered treatment within 2 weeks",
  "freq": "12M", 
  "source_table": "EIP23d_common",
  "filter_clause": (F.col("days_between_endate_ReferralRequestReceivedDate") <= 14),
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqServReqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "10d",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap10a_bd, lower_eth_bd, lower_eth_age_band_lower_chap10a_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap10a_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"10e": {
  "name": "Number of referrals not on Early Intervention for Psychosis (EIP) pathway, receiving a first contact and assigned a care co-ordinator with any team",
  "freq": "12M", 
  "source_table": "EIP64abc_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqServReqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "10e",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap10a_bd, lower_eth_bd, lower_eth_age_band_lower_chap10a_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap10a_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"10f": {
  "name": "Number of referrals on Early Intervention for Psychosis (EIP) pathway",
  "freq": "12M", 
  "source_table": "EIPRef_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqServReqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "10f",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap10a_bd, lower_eth_bd, lower_eth_age_band_lower_chap10a_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap10a_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"10g": {
  "name": "Crude rate of referrals on Early Intervention for Psychosis (EIP) pathway that entered treatment per 100,000 population",
  "freq": "12M", 
  "source_table": "EIP23a_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "10a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "referrals",
  "suppression": "percent",
  "breakdowns": [age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, stp_res_bd]
},
"10h": {
  "name": "Crude rate of referrals on Early Intervention for Psychosis (EIP) pathway that entered treatment within 2 weeks per 100,000 population",
  "freq": "12M", 
  "source_table": "EIP23a_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "10b",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "referrals",
  "suppression": "percent",
  "breakdowns": [age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, stp_res_bd]
},
"10i": {
  "name": "Crude rate of open referrals on Early Intervention for Psychosis (EIP) pathway that entered treatment within 2 weeks per 100,000 population",
  "freq": "12M", 
  "source_table": "EIP23d_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "10d",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "referrals",
  "suppression": "percent",
  "breakdowns": [age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, stp_res_bd]
},
"10j": {
  "name": "Crude rate of referrals not on Early Intervention for Psychosis (EIP) pathway, receiving a first contact and assigned a care co-ordinator with any team per 100,000 population",
  "freq": "12M", 
  "source_table": "EIP64abc_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "10e",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "referrals",
  "suppression": "percent",
  "breakdowns": [age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, stp_res_bd]
},
"10k": {
  "name": "Crude rate of referrals on Early Intervention for Psychosis (EIP) pathway per 100,000 population",
  "freq": "12M", 
  "source_table": "EIPRef_common",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "10f",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "referrals",
  "suppression": "percent",
  "breakdowns": [age_band_chap10a_bd, ccg_prac_res_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap10a_bd, imd_decile_bd, stp_res_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 11
ch11_measure_ids = {  
"11a": {
  "name": "Number of people in contact with Specialist Perinatal Mental Health Community Services",
  "freq": "12M", 
  "source_table": "perinatal_master",
  "filter_clause": (F.col("AttContacts") > 0),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_access_filter_agg_df,
  "numerator_id": "11a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_chap11_bd, ccg_prac_res_bd, ccg_res_age_band_higher_bd, ccg_res_upper_eth_bd, ccg_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap11_bd, lower_eth_bd, lower_eth_age_band_lower_chap11_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap11_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_imd_quintile_bd, stp_res_bd],
},
"11b": {
  "name": "Crude rate of people in contact with Specialist Perinatal Mental Health Community Services per 100,000 females",
  "freq": "12M", 
  "source_table": "perinatal_master",
  "filter_clause": (F.col("AttContacts") > 0),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "11a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap11_bd, eng_bd, upper_eth_bd, lower_eth_bd, imd_decile_bd, imd_quintile_bd, upper_eth_age_band_lower_chap11_bd, lower_eth_age_band_lower_chap11_bd],
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 12
ch12_measure_ids = {  
"12a": {
  "name": "Number of discharges from adult acute beds eligible for 72 hour follow up",
  "freq": "12M", 
  "source_table": "72h_follow_Master",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(ElgibleDischFlag_Modified)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "12a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "discharges",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_higher_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"12b": {
  "name": "Number of discharges from adult acute beds followed up within 72 hours",
  "freq": "12M", 
  "source_table": "72h_follow_Master",
  "filter_clause": "",
  "aggregate_field": (F.expr("SUM(FollowedUp3Days)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "12b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "discharges",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_higher_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"12c": {
  "name": "Proportion of discharges from adult acute beds that were followed up within 72 hours",
  "freq": "12M", 
  "source_table": "72h_follow_Master",
  "filter_clause": "",
  "aggregate_field": (F.expr("(SUM(FollowedUp3Days) / SUM(ElgibleDischFlag_Modified)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "12b",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "discharges",
  "suppression": "percent",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 13
ch13_measure_ids = {  
"13a": {
  "name": "Number of open referrals to memory services team at the end of the year",
  "freq": "12M", 
  "source_table": "dementia_prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT UniqServReqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "13a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"13b": {
  "name": "Number of contacts with memory services team",
  "freq": "12M", 
  "source_table": "dementia_prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT MHS201UniqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "13b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"13c": {
  "name": "Number of attended contacts with memory services team",
  "freq": "12M", 
  "source_table": "dementia_prep",
  "filter_clause": (F.col("AttendOrDNACode").isin(["5", "6"])),
  "aggregate_field": (F.expr("COUNT(DISTINCT MHS201UniqID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "13c",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "care contacts",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
},
"13d": {
  "name": "Number of people in contact with a memory services team",
  "freq": "12M", 
  "source_table": "dementia_prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "13d",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_common_bd, la_bd, prov_bd, prov_age_band_higher_bd, prov_upper_eth_bd, prov_gender_bd, prov_imd_quintile_bd, stp_res_bd]
 },
 
"13e": {
  "name": "Crude rate of people in contact with a memory services team per 100,000 over 65 population",
  "freq": "12M", 
  "source_table": "dementia_prep",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "13d",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_higher_bd, age_band_common_bd, ccg_prac_res_bd, ccg_prac_res_age_band_higher_bd, ccg_prac_res_upper_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_quintile_bd, comm_region_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_common_bd, lower_eth_bd, lower_eth_age_band_lower_common_bd, gender_bd, gender_age_band_lower_common_bd, imd_decile_bd, imd_quintile_bd, stp_res_bd]
}, 
}

# COMMAND ----------

# DBTITLE 1,Chapter 14
ch14_measure_ids = {  
"14a": {
  "name": "Number of people accessing community mental health services for adults and older adults with serious mental illness who received 2 or more care contacts within the RP",
  "freq": "12M", 
  "source_table": "cmh_rolling_activity",
  "filter_clause": (F.col("Person_ID").isNotNull()),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_access_filter_agg_df,
  "numerator_id": "14a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"14b": {
  "name": "Crude rate of people accessing community mental health services for adults and older adults with serious mental illness who received 2 or more care contacts within the RP per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_rolling_activity",
  "filter_clause": (F.col("Person_ID").isNotNull()),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "14a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 15
ch15_measure_ids = {  
"15a": {
  "name": "Adult and older adult acute admissions in the reporting period",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": (F.expr("CAST(SUM(Admissions) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "15a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"15b": { 
  "name": "Adult and older adult acute admissions for patients with contact in the prior year with mental health services, in the RP",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": (F.expr("CAST(SUM(Contact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "15b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"15c": {  
  "name": "Adult and older adult acute admissions for patients with no contact in the prior year with mental health services, in the RP",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": (F.expr("CAST(SUM(NoContact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "15c",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"15d": {
  "name": "Percentage of adult and older adult acute admissions for patients with contact in the prior year with mental health services, in the RP",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": (F.expr("CAST((SUM(Contact)/SUM(Admissions))*100 AS FLOAT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "15b",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"15e": {
  "name": "Percentage of adult and older adult acute admissions for patients with no contact in the prior year with mental health services, in the RP",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": (F.expr("CAST((SUM(NoContact)/SUM(Admissions))*100 AS FLOAT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "15c",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},  
"15f": {
  "name": "Chidren and young people acute admissions in the RP aged 0 to 17",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("CAST(SUM(Admissions) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15f",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"15g": {
  "name": "Adult acute admissions in the RP aged 18 to 64",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("CAST(SUM(Admissions) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15g",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15h": {
  "name": "Adult acute admissions in the RP aged 65 and over",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("CAST(SUM(Admissions) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15h",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15i": {
  "name": "Chidren and young people acute admissions with contact in the RP aged 0 to 17",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("CAST(SUM(Contact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15i",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15j": {
  "name": "Adult acute admissions with contact in the RP aged 18 to 64",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("CAST(SUM(Contact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15j",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15k": {
  "name": "Adult acute admissions with contact in the RP aged 65 and over",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("CAST(SUM(Contact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15k",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
 "15l": {
  "name": "Chidren and young people acute admissions with no contact in the RP aged 0 to 17",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("CAST(SUM(NoContact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15l",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15m": {
  "name": "Adult acute admissions with no contact in the RP aged 18 to 64",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("CAST(SUM(NoContact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15m",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15n": {
  "name": "Adult acute admissions with no contact in the RP aged 65 and over",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("CAST(SUM(NoContact) AS INT)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "15n",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "hospital spells",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"15o": {
  "name": "Crude Rate of Children and young people acute admissions in the RP aged 0 to 17 per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15f",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15p": {
  "name": "Crude Rate of Adult acute admissions in the RP aged 18 to 64 per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15g",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
   "15q": {
  "name": "Crude Rate of Adult acute admissions in the RP aged 65 and over per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15h",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15r": {
  "name": "Crude Rate of Chidren and young people acute admissions with contact in the RP aged 0 to 17 per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15i",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
   "15s": {
  "name": "Crude Rate of Adult acute admissions with contact in the RP aged 18 to 64 per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15j",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15t": {
  "name": "Crude Rate of Adult acute admissions with contact in the RP aged 65 and over per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15k",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15u": {
  "name": "Crude Rate of Chidren and young people acute admissions with no contact in the RP aged 0 to 17 per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15l",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15v": {
  "name": "Crude Rate of Adult acute admissions with no contact in the RP aged 18 to 64 per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15m",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
  "15w": {
  "name": "Crude Rate of Adult acute admissions with no contact in the RP aged 65 and over per 100,000 population",
  "freq": "12M", 
  "source_table": "cmh_agg",
  "filter_clause": (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "15n",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "hospital spells",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
}

# COMMAND ----------

# DBTITLE 1,Chapter 16
ch16_measure_ids = {  
"16a": {
  "name": "The number of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 60+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": (F.col("HospitalBedTypeMH") == "10") & (F.col("Hosp_LOS") >= 60) & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("COALESCE(COUNT(DISTINCT Person_ID),0)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "16a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16b": {
  "name": "The number of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 90+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": (F.col("HospitalBedTypeMH") == "10") & (F.col("Hosp_LOS") >= 90) & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": (F.expr("COALESCE(COUNT(DISTINCT Person_ID),0)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "16b",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16c": {
  "name": "The number of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 60+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": (F.col("HospitalBedTypeMH") == "11") & (F.col("Hosp_LOS") >= 60) & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("COALESCE(COUNT(DISTINCT Person_ID),0)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "16c",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16d": {
  "name":  "The number of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 90+ days",
  "freq": "12M",
  "source_table": "spells",
  "filter_clause": (F.col("HospitalBedTypeMH") == "11") & (F.col("Hosp_LOS") >= 90) & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": (F.expr("COALESCE(COUNT(DISTINCT Person_ID),0)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "16d",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16e": {
  "name":  "The number of people discharged in the RP aged 0 to 17 with a length of stay of 60+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": (F.col("Hosp_LOS") >= 60) & (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("COALESCE(COUNT(DISTINCT Person_ID),0)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "16e",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, ccg_res_age_band_chap1_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_chap1_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16f": {
  "name":  "The number of people discharged in the RP aged 0 to 17 with a length of stay of 90+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": (F.col("Hosp_LOS") >= 90) & (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": (F.expr("COALESCE(COUNT(DISTINCT Person_ID),0)").alias("METRIC_VALUE")),
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "16f",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, ccg_res_age_band_chap1_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_chap1_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_chap1_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16g": {
  "name": "Crude rate of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 60+ days per 100,000 population",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "16a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16h": {
  "name": "Crude rate of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 90+ days per 100,000 population",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "16b",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16i": {
  "name": "Crude rate of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 60+ days per 100,000 population",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "16c",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16j": {
  "name":  "Crude rate of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 90+ days per 100,000 population",
  "freq": "12M",
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "16d",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16k": {
  "name":  "Crude rate of people discharged in the RP aged 0 to 17 with a length of stay of 60+ days per 100,000 population",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "16e",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_chap1_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16l": {
  "name":  "Crude rate of people discharged in the RP aged 0 to 17 with a length of stay of 90+ days per 100,000 population",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "16f",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_chap1_bd, stp_res_upper_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16m": {
  "name": "Proportion of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 60+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '10' AND AgeRepPeriodEnd BETWEEN 18 and 64 AND Hosp_LOS >= 60 THEN Person_ID ELSE NULL END)/COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '10' AND AgeRepPeriodEnd BETWEEN 18 and 64 THEN Person_ID ELSE NULL END)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "16a",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16n": {
  "name": "Proportion of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 90+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '10' AND AgeRepPeriodEnd BETWEEN 18 and 64 AND Hosp_LOS >= 90 THEN Person_ID ELSE NULL END)/COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '10' AND AgeRepPeriodEnd BETWEEN 18 and 64 THEN Person_ID ELSE NULL END)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "16b",
  "denominator":10,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16o": {
  "name": "Proportion of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 60+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '11' AND AgeRepPeriodEnd >= 65 AND Hosp_LOS >= 60 THEN Person_ID ELSE NULL END)/COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '11' AND AgeRepPeriodEnd >= 65 THEN Person_ID ELSE NULL END)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "16c",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16p": {
  "name":  "Proportion of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 90+ days",
  "freq": "12M",
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '11' AND AgeRepPeriodEnd >= 65 AND Hosp_LOS >= 90 THEN Person_ID ELSE NULL END)/COUNT(DISTINCT CASE WHEN HospitalBedTypeMH = '11' AND AgeRepPeriodEnd >= 65 THEN Person_ID ELSE NULL END)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "16d",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_common_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd,  comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16q": {
  "name":  "Proportion of people discharged in the RP aged 0 to 17 with a length of stay of 60+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN AgeRepPeriodEnd BETWEEN 0 and 17 AND Hosp_LOS >= 60 THEN Person_ID ELSE NULL END)/COUNT(DISTINCT CASE WHEN AgeRepPeriodEnd BETWEEN 0 and 17 THEN Person_ID ELSE NULL END)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "16e",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, ccg_res_age_band_chap1_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_chap1_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_chap1_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
"16r": {
  "name":  "Proportion of people discharged in the RP aged 0 to 17 with a length of stay of 90+ days",
  "freq": "12M", 
  "source_table": "spells",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COUNT(DISTINCT CASE WHEN AgeRepPeriodEnd BETWEEN 0 and 17 AND Hosp_LOS >= 90 THEN Person_ID ELSE NULL END)/COUNT(DISTINCT CASE WHEN AgeRepPeriodEnd BETWEEN 0 and 17 THEN Person_ID ELSE NULL END)) * 100").alias("METRIC_VALUE")),
  "aggregate_function": produce_agg_df,
  "numerator_id": "16f",
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, ccg_res_age_band_chap1_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_chap1_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, imd_decile_bd, prov_bd, prov_age_band_chap1_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_chap1_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd],
},
}

# COMMAND ----------

# DBTITLE 1,Chapter 17
ch17_measure_ids = {  
"17a": {  
  "name": "Number of children and young people aged under 18 supported through NHS funded mental health with at least one contact",
  "freq": "12M", 
  "source_table": "mhb_firstcont_final",
  "filter_clause": (F.col("Metric") == "MHS95"),
  "aggregate_field": (F.expr("COUNT(DISTINCT Person_ID)").alias("METRIC_VALUE")),
  "aggregate_function": produce_access_filter_agg_df,
  "numerator_id": "17a",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, ccg_res_age_band_chap1_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_chap1_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, eng_bd, upper_eth_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_bd, lower_eth_age_band_lower_chap1_bd, gender_bd, gender_age_band_lower_chap1_bd, imd_decile_bd, imd_quintile_bd, imd_decile_age_band_lower_chap1_bd, prov_bd, prov_age_band_chap1_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, stp_res_bd, stp_res_age_band_chap1_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd], 
},
"17b": {
  "name": "Crude rate of children and young people aged under 18 supported through NHS funded mental health with at least one contact per 100,000 population aged 0-17",
  "freq": "12M", 
  "source_table": "mhb_firstcont_final",
  "filter_clause": "",
  "aggregate_field": (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "17a",
  "denominator": 1,
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [age_band_chap1_bd, ccg_res_bd, comm_region_bd, eng_bd, upper_eth_bd, lower_eth_bd, gender_bd, gender_age_band_lower_chap1_bd, imd_decile_bd, stp_res_bd, stp_res_age_band_chap1_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd, upper_eth_age_band_lower_chap1_bd, lower_eth_age_band_lower_chap1_bd]
}
}

# COMMAND ----------

# DBTITLE 1,Chapter 18
ch18_measure_ids = {
'18a' : {
  'name': 'Number of referrals that accessed Individual Placement Support (IPS) in the reporting period',
  'freq': '12M',
  'source_table': 'ips_master',                                
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN AccessFlag = 1 THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'filter_clause': '',
  'aggregate_function': produce_agg_df,
  'numerator_id': '18a', 
  'denominator': 0,
  "crude_rate": 0,
  'related_to': 'referrals',
  'suppression': 'count',
  'breakdowns': [eng_bd, age_band_common_bd, gender_bd, upper_eth_bd, lower_eth_bd, imd_decile_bd, prov_bd, prov_age_band_common_bd, prov_upper_eth_bd, prov_lower_eth_bd, prov_gender_bd, prov_imd_decile_bd, ccg_res_bd, ccg_res_age_band_common_bd, ccg_res_upper_eth_bd, ccg_res_lower_eth_bd, ccg_res_gender_bd, ccg_res_imd_decile_bd, comm_region_bd, comm_region_age_band_common_bd, comm_region_upper_eth_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, gender_age_band_lower_common_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd, upper_eth_age_band_lower_common_bd, lower_eth_age_band_lower_common_bd, imd_decile_age_band_lower_common_bd],
  'output_table': 'ips_monthly'
},
'18b' : {
  'name': 'Crude rate of referrals that accessed Individual Placement Support (IPS) in the reporting period per 100,000 of the population',
  'freq': '12M',
  'source_table': 'ips_master',                                  
  'aggregate_field': (F.expr("(COALESCE(SUM(NUMERATOR_COUNT)/SUM(POPULATION_COUNT), 0))*100000").alias("METRIC_VALUE")),
  'filter_clause': '',
  'aggregate_function': produce_crude_rate_agg_df,
  'numerator_id': '18a',  
  'denominator': 1,
  "crude_rate": 1,
  'related_to': 'referrals',
  'suppression': 'percent',
  'breakdowns': [eng_bd, age_band_common_bd, gender_bd, upper_eth_bd, lower_eth_bd, imd_decile_bd, prov_bd, ccg_res_bd, comm_region_bd, gender_age_band_lower_common_bd, stp_res_bd, stp_res_age_band_common_bd, stp_res_upper_eth_bd, stp_res_lower_eth_bd, stp_res_gender_bd, stp_res_imd_decile_bd, upper_eth_age_band_lower_common_bd, lower_eth_age_band_lower_common_bd],
  'output_table': 'ips_monthly'
},
}

# COMMAND ----------

# DBTITLE 1,Chapter 19
ch19_measure_ids = {
'19a' : {
  'freq': 'M',
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts',  
  'source_table': 'cyp_master',     
  "filter_clause": "",
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19a',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19b' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_ANY = 1 THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19b',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ca' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_ANY = 1 THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19b',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19cb' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19cb',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19cc' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19cb',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19cd' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19cd',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ce' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19cd',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19cf' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19cf',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19cg' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19cf',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19d' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_ANY = 1 THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19d',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ea' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_ANY = 1 THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19d',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19eb' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19eb',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19ec' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19eb',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ed' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ed',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19ee' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ed',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ef' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ef',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19eg' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ef',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19fa' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("SUM(COALESCE(Improvement_SR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19fa',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19fb' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(Improvement_SR,0))/COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19fa',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19fc' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                             
  'aggregate_field': (F.expr("SUM(COALESCE(Deter_SR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19fc',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19fd' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(Deter_SR,0))/COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19fc',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19fe' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("SUM(COALESCE(NoChange_SR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19fe',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ff' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(NoChange_SR,0))/COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19fe',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19ga' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("SUM(COALESCE(Improvement_PR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ga',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': "count",
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19gb' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(Improvement_PR,0))/COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ga',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19gc' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("SUM(COALESCE(Deter_PR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19gc',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19gd' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(Deter_PR,0))/COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19gc',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19ge' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("SUM(COALESCE(NoChange_PR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ge',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19gf' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',
  "filter_clause": "",                
  'date_column': 'ReportingPeriodStartDate',                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(NoChange_PR,0))/COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ge',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19ha' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("SUM(COALESCE(Improvement_CR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ha',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19hb' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',       
  "filter_clause": "",                    
  'date_column': 'ReportingPeriodStartDate',                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(Improvement_CR,0))/COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19ha',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
}, 
'19hc' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',       
  "filter_clause": "",                    
  'date_column': 'ReportingPeriodStartDate',                              
  'aggregate_field': (F.expr("SUM(COALESCE(Deter_CR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19hc',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19hd' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(Deter_CR,0))/COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19hc',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19he' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': (F.expr("SUM(COALESCE(NoChange_CR,0))").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19he',
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
'19hf' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': (F.expr("ROUND((SUM(COALESCE(NoChange_CR,0))/COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)").alias("METRIC_VALUE")),
  'aggregate_function': produce_agg_df,
  'numerator_id': '19he',
  "denominator": 1,
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_res_bd, comm_region_bd, age_band_chap1_bd, lower_eth_bd, upper_eth_bd, gender_bd, imd_decile_bd],
  "output_table": "cyp_outcomes_monthly"
},
}

# COMMAND ----------

# DBTITLE 1,Combine Dictionaries into one:
#amend to be a dictionary of a dictionary so single/multiple chapters can be used rather running all chapters in a test run
automated_metric_metadata = {
  "ALL": {**ch01_measure_ids, **ch04_measure_ids, **ch05_measure_ids, **ch06_measure_ids, **ch07_measure_ids, **ch09_measure_ids, **ch10_measure_ids, **ch11_measure_ids, **ch12_measure_ids, **ch13_measure_ids, **ch14_measure_ids, **ch15_measure_ids, **ch16_measure_ids, **ch17_measure_ids, **ch18_measure_ids, **ch19_measure_ids},
  "CHAP1": {**ch01_measure_ids},
  "CHAP4": {**ch04_measure_ids},
  "CHAP5": {**ch05_measure_ids},
  "CHAP6": {**ch06_measure_ids},
  "CHAP7": {**ch04_measure_ids, **ch07_measure_ids}, #chapter 4 added for bed days denominator
  "CHAP9": {**ch09_measure_ids},
  "CHAP10": {**ch10_measure_ids},
  "CHAP11": {**ch11_measure_ids},
  "CHAP12": {**ch12_measure_ids},
  "CHAP13": {**ch13_measure_ids},
  "CHAP14": {**ch14_measure_ids},
  "CHAP15": {**ch15_measure_ids},
  "CHAP16": {**ch16_measure_ids},
  "CHAP17": {**ch17_measure_ids},
  "CHAP18": {**ch18_measure_ids},
  "CHAP19": {**ch19_measure_ids},
  "CUSTOM_RUN": {**ch01_measure_ids, **ch04_measure_ids},
}

# COMMAND ----------

def chapter(metric):
  alphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j",
             "k", "l", "m", "n", "o", "p", "q", "r", "s", "t",
             "u", "v", "w", "x", "y", "z"]
  for x in alphabet: metric = metric.replace(x, "")
  return int(metric)

amd = automated_metric_metadata["ALL"]

l2 = [[amd[measure_id]["suppression"],
       chapter(measure_id),
       measure_id,
       amd[measure_id]["numerator_id"],
       amd[measure_id]["crude_rate"],
       breakdown["breakdown_name"],
       amd[measure_id]["name"]
      ] for measure_id in amd 
       for breakdown in amd[measure_id]["breakdowns"]]
 
print(f"{timenow()} create den_num_df")
for x in l2[:5]: pass
schema = "suppression string, Chapter int, measure_id string, numerator_id string, crude_rate int, breakdown string, measure_name string"
# den_num_df = spark.createDataFrame(l2, schema = schema)
# display(den_num_df)